# Docker Compose configuration for testing Tenant Access Request Service locally
# This includes all required dependencies for standalone testing.
services:
  tenant-access-request-service:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      # Slack configuration
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET}
      - SLACK_CHANNEL_ID=${SLACK_CHANNEL_ID}

      # Governance API configuration
      - GOVERNANCE_API_URL=http://minio-manager-service:8000

      # KBase Auth configuration
      - KBASE_AUTH_URL=https://ci.kbase.us/services/auth/
      - KBASE_ADMIN_ROLES=CDM_JUPYTERHUB_ADMIN
      - KBASE_REQUIRED_ROLES=BERDL_USER

      # Logging
      - LOG_LEVEL=DEBUG
    depends_on:
      - minio-manager-service

  minio-manager-service:
    image: ghcr.io/berdatalakehouse/minio_manager_service:main
    platform: linux/amd64
    ports:
      - "8003:8000"
    environment:
      - MINIO_ENDPOINT=http://minio:9002
      - MINIO_ROOT_USER=minio
      - MINIO_ROOT_PASSWORD=minio123
      - KBASE_AUTH_URL=https://ci.kbase.us/services/auth/
      - KBASE_ADMIN_ROLES=CDM_JUPYTERHUB_ADMIN
      - KBASE_APPROVED_ROLES=BERDL_USER
      - REDIS_URL=redis://redis:6379
    depends_on:
      - minio
      - redis

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  minio:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z-cpuv1
    ports:
      - "9002:9002"
      - "9003:9003"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    healthcheck:
      test: timeout 5s bash -c ':> /dev/tcp/127.0.0.1/9002' || exit 1
      interval: 1s
      timeout: 10s
      retries: 5
    command: server --address 0.0.0.0:9002 --console-address 0.0.0.0:9003 /data
    volumes:
      - minio_data:/data

  minio-create-buckets:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      echo 'Configuring MinIO...';
      mc alias set local http://minio:9002 minio minio123;
      echo 'Creating buckets...';
      mc mb --ignore-existing local/cdm-lake;
      echo 'MinIO bucket creation complete.';
      "

volumes:
  redis_data:
  minio_data:
